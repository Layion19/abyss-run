<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Angry Whales ‚Äî Abyss Run</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Orbitron:wght@500&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="static/abyss/css/game.css">
  <link rel="icon" href="static/abyss/img/favicon.ico">
  <style>
    :root{ --brand-yellow:#ffcc00; --brand-blue:#6dd5ff; }
    html,body{ margin:0; padding:0; }
    .wrap{ max-width:1400px; margin:0 auto; padding:16px; }

    .stage{
      background:#0b1427; border:1px solid #1a2a4a; border-radius:14px;
      padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }

    .game-frame{
      position:relative;
      width:min(100%, calc((100vh - 200px) * 16 / 9));
      max-width:1600px;
      margin:0 auto;
      display:block;
      background:#0e172b; border:1px solid #1a2a4a; border-radius:12px; overflow:hidden;
      touch-action:none;
      aspect-ratio:16/9;
    }
    #game{ display:block; width:100%; height:auto; }

    .below{ margin-top:22px; }
    .card{ background:#101a31; border:1px solid #1a2a4a; border-radius:12px; padding:14px; }

    .hud{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .btn{ cursor:pointer; background:#132349; color:#e9f2ff; border:1px solid #274173; border-radius:10px; padding:8px 12px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .pill{ background:#0e1b35; color:#d9e6ff; border:1px solid #223a67; border-radius:999px; padding:6px 10px; }

    .title{ text-align:center; margin-bottom:8px; line-height:1.2; }
    .title .angry{ display:block; font-family:'Bebas Neue',sans-serif; font-size:3.2rem; color:var(--brand-yellow); letter-spacing:2px; }
    .title .abyss{ display:block; font-family:'Orbitron',sans-serif; font-size:1.4rem; color:#6dd5ff; letter-spacing:1px; }
    .sub{ opacity:.9; text-align:center; margin:0 0 10px; }

    .board-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    .board-title{ display:flex; align-items:center; gap:10px; }
    .rank-badge{ background:#0e1b35; border:1px solid #223a67; color:#cfe6ff; padding:6px 10px; border-radius:999px; font-size:14px; cursor:pointer; }
    .actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* ===== Leaderboard avec BULLE ===== */
    .leaders{ list-style:none; margin:10px 0 0; padding:0; }
    .leaders li{
      display:flex; 
      align-items:center; 
      gap:10px; 
      padding:8px 10px; 
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
    }
    .leaders .rank-wallet{ 
      display:flex; 
      align-items:center; 
      gap:6px; 
      white-space:nowrap; 
      flex-shrink:0;
    }
    .leaders .wallet-yellow{ 
      color:#ffcc00; 
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      font-weight:600;
      font-size:13px;
    }
    .leaders .info-bubble{ 
      background:#0e1b35; 
      border:1px solid #223a67; 
      border-radius:999px; 
      padding:6px 12px;
      display:flex; 
      align-items:center; 
      gap:6px; 
      flex:1; 
      min-width:0;
      font-size:12px;
    }
    .leaders .info-bubble .sep{ opacity:0.5; }
    .leaders .bonuses{ 
      display:flex; 
      gap:4px; 
      align-items:center; 
    }
    .leaders .wallet-copy{ 
      color:#6dd5ff; 
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; 
      cursor:pointer; 
      font-size:12px;
      white-space:nowrap;
      flex-shrink:0;
      margin-left:auto;
    }
    .leaders .wallet-copy:hover{ text-decoration:underline; }
    .leaders li.me{ background:rgba(255,204,0,0.08); border-radius:6px; }

    .start-screen{ position:absolute; inset:0; z-index:50; pointer-events:auto; background:#000; }
    #start-bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; display:block; z-index:0; }
    .start-ui{
      position:absolute; left:50%; bottom:24px; transform:translateX(-50%);
      display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center;
      color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.55); pointer-events:auto; z-index:1;
    }
    .start-hints{ font-size:16px; line-height:1.6; margin:0; opacity:.95; white-space:nowrap; }
    #start-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 24px; font-size:20px; line-height:1; font-weight:700;
      border:none; border-radius:8px; background:var(--brand-yellow); color:#000;
      cursor:pointer; box-shadow:0 4px 14px rgba(0,0,0,.35);
    }

    .gameover{ position:absolute; inset:0; z-index:60; display:none; align-items:center; justify-content:center; text-align:center; background:rgba(0,0,0,0.55); }
    .gameover .box{ background:rgba(10,20,40,0.9); border:1px solid #223a67; border-radius:14px; padding:22px 26px; box-shadow:0 10px 30px rgba(0,0,0,.45); max-width:80%; }
    .gameover h2{ margin:0 0 10px; font-family:'Bebas Neue',sans-serif; font-size:54px; letter-spacing:2px; color:#ffcc00; text-shadow:0 2px 10px rgba(0,0,0,.55); }
    .gameover p{ margin:0 0 16px; color:#cfe6ff; }

    .touch-layer{ position:absolute; inset:0; z-index:55; display:none; pointer-events:auto; }
    .touch-half{ position:absolute; left:0; width:100%; height:50%; touch-action:none; }
    .touch-top{ top:0; } .touch-bottom{ bottom:0; }

    .rotate-hint{ position:fixed; inset:0; background:rgba(0,0,0,.82); color:#fff; display:none; align-items:center; justify-content:center; text-align:center; padding:24px; z-index:999999; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .rotate-hint .box{ background:#0f1a30; border:1px solid #233a67; border-radius:12px; padding:18px 22px; max-width:540px; }
    .rotate-hint b{ color:var(--brand-yellow); }

    @media (max-width:900px){
      .wrap{ padding:12px; }
      .title .angry{ font-size:2.4rem; }
      .title .abyss{ font-size:1.1rem; }
      .leaders li{ font-size:11px; gap:6px; padding:6px 8px; }
      .leaders .info-bubble{ font-size:10px; gap:4px; padding:4px 8px; }
      .leaders .wallet-yellow{ font-size:12px; }
      .leaders .wallet-copy{ font-size:11px; }
    }

    /* =================== Bonuses strip =================== */
    .bonus-strip{
      margin-top:22px; margin-bottom:22px; padding:14px 16px;
      background:#101a31; border:0; border-radius:12px; color:#e8f1ff; text-align:center;
    }
    .bonus-strip h3{
      margin:0 0 10px; font-size:1.6rem; font-family:'Bebas Neue',sans-serif;
      letter-spacing:.5px; color:#ffcc00;
    }
    .bonus-list{ display:flex; flex-wrap:wrap; gap:12px 16px; justify-content:center; }
    .bonus-item{
      min-width:240px; padding:8px 12px; background:#0b1427; border-radius:10px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .bonus-left{ display:flex; align-items:center; gap:8px; }
    .bonus-emoji{ font-size:18px; }
    .bonus-name{ font-weight:700; }
    .bonus-right{ text-align:right; }
    .bonus-count{ font-weight:800; display:block; }
    .bonus-reward{ font-size:12px; opacity:.85; }

    @media (max-width:900px){
      .bonus-item{ min-width:unset; width:100%; }
    }
  </style>
</head>
<body>
  <div id="rotateHint" class="rotate-hint" aria-hidden="true">
    <div class="box">
      <p style="margin:0 0 6px;">For a better experience, please rotate your phone.</p>
      <p style="margin:0;"><b>Landscape mode</b> is required to play.</p>
    </div>
  </div>

  <div class="wrap">
    <h1 class="title">
      <span class="angry">Angry Whales</span>
      <span class="abyss">Abyss Run</span>
    </h1>
    <p class="sub">Survive the abyss, collect orbs, uncover hidden bonuses, and rule the leaderboard üèÜ</p>

    <!-- ======= GAME ======= -->
    <section id="stage" class="stage">
      <div class="game-frame" id="gameFrame">
        <div id="start-screen" class="start-screen">
          <img id="start-bg" src="static/abyss/img/start-screen.png" alt="">
          <div class="start-ui">
            <p class="start-hints">‚Ä¢ SHIFT = Boost ‚Ä¢ ‚Üë/‚Üì = Move ‚Ä¢ </p>
            <button id="start-btn">‚ñ∂ Play</button>
          </div>
        </div>

        <canvas id="game" width="1280" height="720"></canvas>

        <div id="gameover" class="gameover" aria-hidden="true">
          <div class="box">
            <h2>GAME OVER</h2>
            <p>Try again and beat your best score!</p>
            <button id="go-restart" type="button">üîÑ Restart</button>
          </div>
        </div>

        <div id="touchLayer" class="touch-layer" aria-hidden="true">
          <div id="touchTop" class="touch-half touch-top"></div>
          <div id="touchBottom" class="touch-half touch-bottom"></div>
        </div>
      </div>

      <!-- HUD -->
      <div class="hud">
        <button id="play" class="btn" disabled>‚ñ∂Ô∏è Play</button>
        <button id="restart" class="btn">üîÑ Restart</button>

        <span class="pill">
          üéµ Music:
          <input id="musicToggle" type="range" min="0" max="100" value="60" style="vertical-align:middle;">
          <span id="musicVol">100%</span>
        </span>

        <button id="music" class="btn" aria-pressed="true">üéµ Music: On</button>
        <button id="sfx" class="btn" aria-pressed="true">üîä SFX: On</button>

        <span class="pill">ü™ô Score: <b id="score">0</b></span>
        <span class="pill">‚ù§Ô∏è Lives: <b id="lives">4</b></span>
      </div>
    </section>

    <!-- ======= BONUS INFO SECTION ======= -->
    <section class="bonus-strip" aria-live="polite">
      <h3>üéØ Active Bonuses</h3>
      <div class="bonus-list">
        <!-- Specials -->
        <div class="bonus-item">
          <div class="bonus-left">
            <span class="bonus-emoji">üü¢</span>
            <span class="bonus-name">Specials</span>
          </div>
          <div class="bonus-right">
            <span class="bonus-count" id="specialsCount">4</span>
            <span class="bonus-reward">üíµ Bonus 50$ Wagering</span>
          </div>
        </div>

        <!-- Silver -->
        <div class="bonus-item">
          <div class="bonus-left">
            <span class="bonus-emoji">ü•à</span>
            <span class="bonus-name">Silver</span>
          </div>
          <div class="bonus-right">
            <span class="bonus-count" id="silverCount">20</span>
            <span class="bonus-reward">üéÅ Random ETH drop</span>
          </div>
        </div>

        <!-- Gold -->
        <div class="bonus-item">
          <div class="bonus-left">
            <span class="bonus-emoji">ü•á</span>
            <span class="bonus-name">Gold</span>
          </div>
          <div class="bonus-right">
            <span class="bonus-count" id="goldCount">1</span>
            <span class="bonus-reward">üêá 1√ó Stoned Rabbits</span>
          </div>
        </div>

        <!-- Platinum -->
        <div class="bonus-item">
          <div class="bonus-left">
            <span class="bonus-emoji">üí†</span>
            <span class="bonus-name">Platinum</span>
          </div>
          <div class="bonus-right">
            <span class="bonus-count" id="platinumCount">1</span>
            <span class="bonus-reward">üÉè Gamblor Deck</span>
          </div>
        </div>

        <!-- Diamonds -->
        <div class="bonus-item">
          <div class="bonus-left">
            <span class="bonus-emoji">üíé</span>
            <span class="bonus-name">Diamonds</span>
          </div>
          <div class="bonus-right">
            <span class="bonus-count" id="diamondsCount">‚Äî</span>
            <span class="bonus-reward"><em>Coming Soon ‚Ä¶</em></span>
          </div>
        </div>

        <!-- Angry Whales -->
        <div class="bonus-item">
          <div class="bonus-left">
            <span class="bonus-emoji">üî¥</span>
            <span class="bonus-name">Angry Whales</span>
          </div>
          <div class="bonus-right">
            <span class="bonus-count" id="angryWhalesCount">5</span>
            <span class="bonus-reward">üê≥ 5√ó Angry Whales</span>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= LEADERBOARD ======= -->
    <section class="below card">
      <div class="board-header">
        <div class="board-title">
          <h3 style="margin:0">üèÜ Leaderboard</h3>
        </div>
        <div class="actions">
          <button id="showRankBtn" class="btn btn-outline" type="button">Your rank</button>
          <span id="rankBadge" class="rank-badge" title="Click to copy your wallet">Rank: ‚Äî</span>
        </div>
      </div>

      <ol id="leaders" class="leaders"><li>No entries yet.</li></ol>
      <p class="hint">Sorted by XP first, then score. Auto-refresh (5 min).</p>

      <div id="rankResult" class="rank-result" style="display:none;">Your rank: <b>‚Äî</b></div>
    </section>
  </div>

  <!-- Wallet gate -->
  <script src="https://unpkg.com/@metamask/sdk/dist/browser/es/metamask-sdk.js"></script>
  <script type="module" src="static/abyss/js/wallet.js"></script>
  <script src="static/abyss/js/game.js"></script>

  <!-- Canvas sizing -->
  <script>
    (function syncCanvasToFrame(){
      const frame  = document.getElementById('gameFrame');
      const canvas = document.getElementById('game');
      if (!frame || !canvas) return;
      const ASPECT = 16/9;

      function applySize() {
        const fw = Math.max(320, Math.floor(frame.clientWidth));
        const fh = Math.floor(fw / ASPECT);
        canvas.style.width  = fw + 'px';
        canvas.style.height = 'auto';
        canvas.width  = fw;
        canvas.height = fh;
        window.dispatchEvent(new Event('resize'));
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', applySize, {once:true});
      } else { applySize(); }
      try { new ResizeObserver(applySize).observe(frame); } catch(_) {
        window.addEventListener('resize', applySize);
        window.addEventListener('orientationchange', () => setTimeout(applySize, 60));
      }
      document.addEventListener('visibilitychange', () => { if (!document.hidden) setTimeout(applySize, 60); });
    })();
  </script>

  <!-- UI + backend wiring -->
  <script>
    const qs = id => document.getElementById(id);
    const leadersOl  = qs('leaders');
    const rankBadge  = qs('rankBadge');
    const rankBtn    = qs('showRankBtn');

    function wallet(){ return localStorage.getItem('walletAddress') || null; }
    async function safeJson(url){
      const r = await fetch(url).catch(()=>null);
      if (!r || !r.ok) return null;
      try{ return await r.json(); }catch{ return null; }
    }

    function gateOk() { return !!(window.AW_ACCESS && window.AW_ACCESS.canPlay === true); }
    function requireGate(msg) {
      if (gateOk()) return true;
      try { window.AW_GATE && window.AW_GATE.show(msg || "Connect your wallet to play."); } catch {}
      return false;
    }

    // Bonus strip refresh
    async function refreshBonusPanel(){
      const d = await safeJson('api/bonus/remaining');
      if (!d) return;
      const s = qs('silverCount');     if (s && d.silver   != null) s.textContent = d.silver;
      const g = qs('goldCount');       if (g && d.gold     != null) g.textContent = d.gold;
      const p = qs('platinumCount');   if (p && d.platinum != null) p.textContent = d.platinum;
      const sp = qs('specialsCount');  if (sp && d.special != null) sp.textContent = d.special;
      const aw = qs('angryWhalesCount'); if (aw && d.angrywhales != null) aw.textContent = d.angrywhales;
    }

    document.addEventListener('aw:bonusClaimed', (e) => {
      const t = e?.detail?.type;
      const dec = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const n = parseInt(el.textContent||'0', 10);
        if (!isNaN(n)) el.textContent = Math.max(0, n - 1);
      };
      if (t === 'bonus2')        dec('silverCount');
      else if (t === 'legendary')dec('goldCount');
      else if (t === 'platinum') dec('platinumCount');
      else if (t === 'special')  dec('specialsCount');
      else if (t === 'angrywhales') dec('angryWhalesCount');
    });

    rankBadge?.addEventListener('click', async () => {
      const w = wallet();
      if (!w) return;
      try{ await navigator.clipboard.writeText(w); alert('Wallet address copied'); }catch{}
    });

    rankBtn?.addEventListener('click', async () => {
      const w = wallet();
      if (!w){ alert('Connect your wallet first.'); return; }
      const me = await safeJson(`api/rank/${w}`);
      const rk = (me && me.rank!=null) ? me.rank : '‚Äî';
      qs('rankResult').style.display='block';
      qs('rankResult').querySelector('b').textContent = rk;
      rankBadge.textContent = `Rank: ${rk}`;
    });

    // R√©cup√©rer les bonus d'un wallet
    async function fetchBonusesForWallet(w){
      const d = await safeJson(`api/bonus/stats/${w}`);
      return {
        special: Number(d?.special||0),
        silver: Number(d?.silver||0),
        gold: Number(d?.gold||0),
        platinum: Number(d?.platinum||0),
        diamonds: 0,
        angrywhales: Number(d?.angrywhales||0)
      };
    }

    // Rendu du leaderboard avec BULLE
    async function renderLeaders(rows){
      const list = leadersOl;
      list.innerHTML='';
      if (!rows.length){ list.innerHTML='<li>No entries yet.</li>'; return; }

      const my = wallet();
      
      for (let idx = 0; idx < rows.length; idx++) {
        const row = rows[idx];
        const li = document.createElement('li');
        const xp = row.xp ?? 0;
        const addr = row.player_id || '';
        const short = addr ? addr.slice(0,6)+'‚Ä¶'+addr.slice(-4) : 'player';

        // R√©cup√©rer les bonus de ce wallet
        const bonuses = addr ? await fetchBonusesForWallet(addr) : {
          special:0, silver:0, gold:0, platinum:0, diamonds:0, angrywhales:0
        };

        // D√©terminer si c'est le wallet du joueur actuel
        const isMe = addr && my && addr.toLowerCase() === my.toLowerCase();

        // Gauche: Rang + Wallet JAUNE
        const rankWallet = document.createElement('div');
        rankWallet.className = 'rank-wallet';
        rankWallet.innerHTML = `<span>${idx+1}.</span><span class="wallet-yellow">${short}</span>`;

        // Centre: BULLE avec Rank + XP + Bonus
        const bubble = document.createElement('div');
        bubble.className = 'info-bubble';
        bubble.innerHTML = `
          <span>Rank:${idx+1}</span>
          <span class="sep">¬∑</span>
          <span>XP:${xp}</span>
          <span class="sep">¬∑</span>
          <span class="bonuses">üü¢${bonuses.special} ü•à${bonuses.silver} ü•á${bonuses.gold} üí†${bonuses.platinum} üíé${bonuses.diamonds} üî¥${bonuses.angrywhales}</span>
        `;

        // Droite: Wallet cliquable
        const copyWallet = document.createElement('span');
        copyWallet.className = 'wallet-copy';
        copyWallet.textContent = short;
        copyWallet.title = 'Click to copy';
        copyWallet.setAttribute('data-full', addr);

        if (isMe) li.classList.add('me');

        li.appendChild(rankWallet);
        li.appendChild(bubble);
        li.appendChild(copyWallet);
        list.appendChild(li);

        copyWallet.addEventListener('click', async ()=>{
          const full = copyWallet.getAttribute('data-full');
          try{ await navigator.clipboard.writeText(full); alert('Wallet copied ‚úì'); }catch{}
        });
      }
    }

    async function refreshLeaders(){
      const data = await safeJson('api/leaderboard');
      const rows = (data?.top || []).slice(0, 100);
      await renderLeaders(rows);
    }

    (function start(){
      refreshLeaders();
      refreshBonusPanel();
      setInterval(refreshLeaders, 300000);
      setInterval(refreshBonusPanel, 300000);
    })();

    document.addEventListener('aw:runEnded',     () => { refreshLeaders(); });
    document.addEventListener('aw:bonusClaimed', () => { refreshLeaders(); refreshBonusPanel(); });

    // Protection boutons HUD
    const hudPlay    = document.getElementById('play');
    const hudRestart = document.getElementById('restart');

    if (hudPlay) {
      hudPlay.addEventListener('click', (ev) => {
        if (!gateOk()) {
          ev.preventDefault();
          ev.stopPropagation();
          requireGate();
          return false;
        }
      }, true);
    }
    if (hudRestart) {
      hudRestart.addEventListener('click', (ev) => {
        if (!gateOk()) {
          ev.preventDefault();
          ev.stopPropagation();
          requireGate();
          return false;
        }
      }, true);
    }
    function updateHudGateState() {
      if (hudPlay) hudPlay.disabled = !gateOk();
    }
    document.addEventListener('aw:access', updateHudGateState);
    updateHudGateState();

    // Start overlay gated
    (function wireStartOverlay(){
      const overlay = document.getElementById('start-screen');
      const startBtn = document.getElementById('start-btn');
      const hudPlay  = document.getElementById('play');
      if (!startBtn) return;

      startBtn.addEventListener('click', (ev) => {
        if (!gateOk()) {
          ev.preventDefault();
          requireGate("You must connect a wallet holding ‚â•1 Angry Whale to start.");
          return false;
        }
        if (overlay) overlay.style.display = 'none';
        if (hudPlay) { hudPlay.disabled = false; try{ hudPlay.click(); }catch{} }
      });

      document.addEventListener('aw:access', () => {
        if (gateOk()) {
          if (hudPlay) hudPlay.disabled = false;
        } else {
          if (hudPlay) hudPlay.disabled = true;
          try { window.AW_GATE && window.AW_GATE.show(); } catch {}
        }
      });
    })();

    // Game over overlay
    (function wireGameOverOverlay(){
      const goOverlay = document.getElementById('gameover');
      const goRestart = document.getElementById('go-restart');
      const hudRestart= document.getElementById('restart');
      if (!goRestart) return;
      goRestart.addEventListener('click', () => {
        try{ hudRestart && hudRestart.click(); }catch{}
        if (goOverlay) goOverlay.style.display = 'none';
      });
    })();

    // Mobile helpers
    (function(){
      const ua = navigator.userAgent || '';
      const isMobileUA  = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
      const hasTouch    = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
      const isMobileLike= isMobileUA || hasTouch;
      if (!isMobileLike) {
        document.getElementById('rotateHint')?.setAttribute('aria-hidden','true');
        document.getElementById('touchLayer')?.setAttribute('aria-hidden','true');
        return;
      }
      const touchLayer  = document.getElementById('touchLayer');
      const touchTop    = document.getElementById('touchTop');
      const touchBottom = document.getElementById('touchBottom');

      function landscape(){ return window.innerWidth > window.innerHeight; }
      function updateTouchLayerVisibility(){
        const show = landscape();
        if (touchLayer){
          touchLayer.style.display = show ? 'block' : 'none';
          touchLayer.setAttribute('aria-hidden', show ? 'false' : 'true');
        }
      }
      function emitGameEvent(name, detail){ document.dispatchEvent(new CustomEvent(name, { detail })); }
      function bindHold(el, actionDown, actionUp){
        if (!el) return; let pressed=false, lastTap=0;
        const onDown = (ev)=>{
          pressed=true; touchLayer && touchLayer.classList.add('active');
          emitGameEvent(actionDown);
          const now = ev.timeStamp || Date.now();
          if (now - lastTap < 280){ emitGameEvent('boost:start'); }
          lastTap = now; ev.preventDefault();
        };
        const onUp = (ev)=>{
          if (pressed){ emitGameEvent(actionUp); }
          pressed=false; touchLayer && touchLayer.classList.remove('active'); ev.preventDefault();
        };
        el.addEventListener('touchstart', onDown, {passive:false});
        el.addEventListener('touchend',   onUp,   {passive:false});
        el.addEventListener('touchcancel',onUp,   {passive:false});
      }
      bindHold(touchTop,    'touch:up:down',   'touch:up:up');
      bindHold(touchBottom, 'touch:down:down', 'touch:down:up');

      updateTouchLayerVisibility();
      window.addEventListener('resize', updateTouchLayerVisibility);
      window.addEventListener('orientationchange', updateTouchLayerVisibility);

      const rotateHint = document.getElementById('rotateHint');
      function updateRotateHint(){
        const show = !landscape() && Math.min(window.innerWidth, window.innerHeight) < 860;
        if (rotateHint){
          rotateHint.style.display = show ? 'flex' : 'none';
          rotateHint.setAttribute('aria-hidden', show ? 'false' : 'true');
        }
      }
      updateRotateHint();
      window.addEventListener('resize', updateRotateHint);
      window.addEventListener('orientationchange', updateRotateHint);
    })();
  </script>
</body>
</html>